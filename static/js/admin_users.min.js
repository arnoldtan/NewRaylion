/*! RaylionWebProject 27-12-2014 */
"use strict";!function(){function a(a){var b=new XMLHttpRequest;b.open("GET","/data/admin/users?userdata=1&userslist=1",!0),b.onload=function(){this.status>=200&&this.status<400?(d=JSON.parse(this.response),a(null)):a(this.status)},b.onerror=function(){a("connection error")},b.send()}function b(a){var b=document.getElementById("user"),c=document.getElementById("usersList");b.href="users/"+d.userData.username,b.text=d.userData.username;for(var e=!0,f=["#FFE4B2","#FFF"],g=0;g<d.usersList.length;++g){var h=document.createElement("div");h.classList.add("userDiv"),h.style.backgroundColor=e?f[0]:f[1],h.innerHTML=d.usersList[g].value.username,h.id=g.toString(),c.appendChild(h),e=!e}a(null)}function c(){function a(){h.children[4].value=h.children[5].value=h.children[6].value="",h.children[7].value="普通用户",i.style.display="none",j.style.display="none"}function b(){l.style.display="none",k.style.display="none",j.style.display="none",i.style.display="none",l.style.opacity=0,k.style.opacity=0,j.style.opacity=0,i.style.opacity=0}function c(a){var b=+new Date,c=function(){a.style.opacity=+a.style.opacity+(new Date-b)/400,b=+new Date,+a.style.opacity<1&&(window.requestAnimationFrame&&requestAnimationFrame(c)||setTimeout(c,16))};c()}function e(){return h.children[5].value!==h.children[6].value?(i.style.display="block",c(i),!1):/^[a-z0-9]{1,32}$/i.test(h.children[4].value)?/^[\S]{8,40}$/i.test(h.children[5].value)?!0:(l.style.display="block",c(l),!1):(k.style.display="block",c(k),!1)}var f,g=document.getElementById("addUser"),h=document.getElementById("addUserForm"),i=document.getElementById("unmatched-passwords"),j=document.getElementById("username-exists"),k=document.getElementById("invalid-username"),l=document.getElementById("invalid-password"),m=document.getElementById("updateUserForm"),n=document.getElementById("updateUserFormUsername"),o=document.getElementById("updateUserFormPermissionLevel"),p=document.getElementById("userPositionsPanel"),q=document.getElementById("userPositionsList"),r=document.getElementById("updateUserInfoButton"),s=document.getElementById("removeUserButton"),t=document.getElementById("usersList");t.addEventListener("click",function(a){if("usersList"!==a.target.id){if(h.style.display="none",f=a.target.id,n.value=d.usersList[f].value.username,o.value=d.usersList[f].value.permission.level,r.disabled="disabled",d.usersList[f].value.permission.positions&&0!==d.usersList[f].value.permission.positions.length){o.disabled=!0;for(var b="",c=0;c<d.usersList[f].value.permission.positions.length;++c)b+="<tr><td>"+d.usersList[f].value.permission.positions[c].name+"</td><td>"+d.usersList[f].value.permission.positions[c].location+"</td></tr>";q.innerHTML=b,p.style.display="block"}else o.disabled=!1,p.style.display="none";m.style.display="block"}}),g.addEventListener("click",function(){a(),m.style.display="none",h.style.display="block"}),o.addEventListener("change",function(){return this.value===d.usersList[f].value.permission.level?void(r.disabled=!0):void(r.disabled=!1)}),s.addEventListener("click",function(){if(confirm("Are you sure you want to remove "+d.usersList[f].value.username+" from the system?")){var a=new XMLHttpRequest;a.open("DELETE","/admin/users",!0),a.setRequestHeader("Content-Type","application/json"),a.onload=function(){this.status>=200&&this.status<400?JSON.parse(this.response).error?console.error(JSON.parse(this.response).error):m.style.display="none":console.error(this.status)},a.onerror=function(){console.error("connection error")},a.send(JSON.stringify({username:d.usersList[f].value.username}))}}),r.addEventListener("click",function(){if(confirm("Are you sure you want to update "+d.usersList[f].value.username+"'s info?")){var a=new XMLHttpRequest;a.open("POST","/admin/users",!0),a.setRequestHeader("Content-Type","application/json"),a.onload=function(){this.status>=200&&this.status<400?JSON.parse(this.response).error?console.error(JSON.parse(this.response).error):m.style.display="none":console.error(this.status)},a.onerror=function(){console.error("connection error")},a.send(JSON.stringify({username:d.usersList[f].value.username,options:[{action:"change user permission level",level:o.value}]}))}}),h.onsubmit=function(d){if(d.preventDefault(),b(),e()){var f=new XMLHttpRequest,g={username:h.children[4].value,password:h.children[5].value,permission:{level:h.children[7].value}};f.open("PUT","/admin/users",!0),f.setRequestHeader("Content-Type","application/json"),f.onload=function(){var b=JSON.parse(this.response);return b.error?(j.style.display="block",void c(j)):(a(),void(h.style.display="none"))},f.send(JSON.stringify(g))}}}var d={};a(function(a){a&&console.error(a),b(function(a){a&&console.error(a),c()})})}();