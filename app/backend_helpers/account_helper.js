/*! RaylionWebProject 27-12-2014 */
"use strict";function addUser(a,b){return a.username?a.password?a.permission.level?/^[a-z0-9]{1,32}$/i.test(a.username)?/^[\S]{8,40}$/i.test(a.password)?void userExists(a.username,function(c,d){return c?b(c):d?b("Error: user already exists"):void bcrypt.genSalt(10,function(c,d){return c?b(c):void bcrypt.hash(a.password,d,function(c,d){if(c)return b(c);var e={username:a.username,password:d,permission:{level:a.permission.level}};"普通用户"===e.permission.level&&(e.permission.group=!1,e.permission.groupLeader=!1,e.permission.subGroupLeader=!1,e.permission.positions=[]),usersDb.save(a.username,e,function(a){return a?b(a):void b(null)})})})}):b("Signup Error: invalid password"):b("Signup Error: invalid username"):b("Signup Error: permission level not provided"):b("Signup Error: password not provided"):b("Signup Error: username not provided")}function userExists(a,b){docExists(usersDb,a,function(a,c){return a?b(a,null):void b(null,c)})}function removeUser(a,b){removeDoc(usersDb,a,function(a){return b(a)})}function updateUser(a,b,c){for(var d=0;d<b.length;++d)!function(d){"change user permission level"===b[d].action?getDoc(usersDb,a,function(a,e){return a?c(a):b[d].level===e.permission.level?c("Error: user permission level is equal to new level"):"管理员"===b[d].level&&0!==e.permission.positions.length?c("Error: user already belongs to a group and cannot be an admin"):("普通用户"===b[d].level&&(e.permission.group=!1,e.permission.groupLeader=!1,e.permission.subGroupLeader=!1,e.permission.positions=[]),"管理员"===b[d].level&&(delete e.permission.group,delete e.permission.groupLeader,delete e.permission.subGroupLeader,delete e.permission.positions),e.permission.level=b[d].level,void usersDb.save(e._id,e._rev,e,function(a){return a?c(a):void c(null)}))}):"add group leader"===b[d].action&&getDoc(usersDb,a,function(a,e){return a?c(a):(e.permission.positions.push({name:b[d].name,location:b[d].location}),e.permission.groupLeader=!0,e.permission.group=b[d].location,void usersDb.save(e._id,e._rev,e,function(a){return a?c(a):void c(null)}))})}(d)}function login(a,b,c){usersDb.get(a,function(a,d){return a?c(a,null):void bcrypt.compare(b,d.password,function(a,b){return c(a,b)})})}function getUser(a,b){getDoc(usersDb,a,function(a,c){return a?b(a,null):(delete c._rev,delete c.password,delete c._id,b(null,c))})}function getAllUsers(a){usersDb.view("users/all",function(b,c){return b?a(b,null):void a(null,c)})}var bcrypt=require("bcrypt"),db_helper=require("./db_helper.js"),usersDb=db_helper.dbConn().database("users"),docExists=db_helper.docExists,getDoc=db_helper.getDoc,removeDoc=db_helper.removeDoc,updateDoc=db_helper.updateDoc;exports.addUser=addUser,exports.removeUser=removeUser,exports.updateUser=updateUser,exports.login=login,exports.getUser=getUser,exports.getAllUsers=getAllUsers,exports.userExists=userExists,exports.usersDb=usersDb;