/*! RaylionWebProject 27-12-2014 */
"use strict";function routes(a){var b=express.Router(),c=express.Router(),d=express.Router({mergeParams:!0});a.all("*",function(a,b,c){"/login"===a.path||a.session.signedIn?c():b.redirect("/login")}),a.get("/",function(a,b){b.redirect("/dashboard")}),a.route("/login").all(function(a,b,c){a.session.signedIn?b.redirect("/dashboard"):c()}).get(function(a,b){b.sendFile(path.resolve(__dirname+"/../static/html/login.min.html"))}).post(jsonParser,function(a,b){login(a.body.username,a.body.password,function(c,d){c&&"not_found"!==c.error?(console.error(c),b.end(JSON.stringify({error:{message:c}}))):!d||c&&"not_found"===c.error?b.end(JSON.stringify({error:{message:"invalid username/password"}})):getUser(a.body.username,function(c,d){c&&(console.error(c),b.end(JSON.stringify({error:{message:c}}))),a.session.user=d,a.session.signedIn=!0,b.end(JSON.stringify({error:null}))})})}),a.get("/dashboard",function(a,b){b.sendFile(path.resolve(__dirname+"/../static/html/dashboard.min.html"))}),a.use("/admin",b),b.all("*",function(a,b,c){return"管理员"!==a.session.user.permission.level?void b.redirect("/dashboard"):void c()}),b.route("/users").get(function(a,b){b.sendFile(path.resolve(__dirname+"/../static/html/admin_users.min.html"))}).put(jsonParser,function(a,b){addUser(a.body,function(a){a?(console.error(a),b.end(JSON.stringify({error:{message:a}}))):b.end(JSON.stringify({error:null}))})}).post(jsonParser,function(a,b){updateUser(a.body.username,a.body.options,function(a){a?(console.error(a),b.end(JSON.stringify({error:{message:a}}))):b.end(JSON.stringify({error:null}))})})["delete"](jsonParser,function(a,b){removeUser(a.body.username,function(a){b.end(a?JSON.stringify({error:{message:a}}):JSON.stringify({error:null}))})}),b.get("/groups",function(a,b){b.sendFile(path.resolve(__dirname+"/../static/html/admin_groups.min.html"))}),a.get("/logout",function(a,b){a.session.destroy(),b.redirect("/login")}),a.use("/data",c),c.get("/dashboard",function(a,b){var c={};"1"===a.query.userdata&&(c.userData=a.session.user),b.end(JSON.stringify(c))}),c.use("/admin",d),d.all("*",function(a,b,c){return"管理员"!==a.session.user.permission.level?void b.redirect("/login"):void c()}),d.get("/users",function(a,b){var c={};"1"===a.query.userdata&&(c.userData=a.session.user),"1"===a.query.userslist&&getAllUsers(function(a,d){a&&console.error(a),c.usersList=d,b.end(JSON.stringify(c))})}),d.get("/groups",function(a,b){var c={};"1"===a.query.userdata&&(c.userData=a.session.user),"1"===a.query.groupslist&&getAllGroups(function(d,e){d&&console.error(d),c.groupsList=e,"1"===a.query.userslist&&getAllUsers(function(a,d){a&&console.error(a),c.usersList=d,b.end(JSON.stringify(c))})})}),a.all("*",function(a,b){b.status(404).end("<h1>404: The Page/Resource Requested Is Not Found</h1>")})}var express=require("express"),path=require("path"),bodyParser=require("body-parser"),jsonParser=bodyParser.json(),account_helper=require("./backend_helpers/account_helper.js"),addUser=account_helper.addUser,removeUser=account_helper.removeUser,updateUser=account_helper.updateUser,login=account_helper.login,getUser=account_helper.getUser,getAllUsers=account_helper.getAllUsers,group_helper=require("./backend_helpers/group_helper.js"),getAllGroups=group_helper.getAllGroups;module.exports=routes;